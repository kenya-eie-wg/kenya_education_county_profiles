---
title: "County Education Profiles -- ASAL Counties"
output: html_document
date: '2023-08-22'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(viridis)
library(readxl)
library(sf)
library(scales)
library(patchwork)
library(janitor)
library(flextable)

theme_set(theme_light())

# Hopefully this allows the DT to show up
options(htmltools.preserve.raw = FALSE)

# disabling scientific notation
options(scipen = 100)

`%out%` <- Negate(`%in%`)

# function for transposing df
transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}

# scaling functions 
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

#mode function 
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

not_all_na <- function(x) any(!is.na(x))
not_any_na <- function(x) all(!is.na(x))
```


```{r data}

locations <- read_xlsx("./data/ken_adminboundaries_tabulardata.xlsx", 
                      sheet = "ADM1") %>% 
  clean_names()

pcode1_shape <- 
  sf::st_read("./data/ken_adm_iebc_20191031_shp/ken_admbnda_adm1_iebc_20191031.shp", 
          quiet = TRUE) %>% 
  clean_names()

counties <- read_csv("./data/counties.csv") %>% 
  mutate(sex_modifier = fct_relevel(sex_modifier, c("male", "female", "total")), 
         county = recode(county, "national" = "National"))
```

# School-aged children

```{r}

pop_summary <- counties %>% 
    filter(indicator %in% c("county_population", "school_age_children") & 
           sex_modifier == "total") %>% 
  pivot_wider(names_from = indicator, 
              values_from = value) %>% 
  mutate(pc = school_age_children / county_population * 100) 

population_sort_order <- counties %>%
  filter(indicator %in% c("county_population", "school_age_children") & 
           sex_modifier == "total") %>% 
  pivot_wider(names_from = indicator, 
              values_from = value) %>% 
  mutate(pc = school_age_children / county_population * 100) %>% 
  arrange(desc(school_age_children)) %>% 
  pull(county)


counties %>%
  filter(indicator %in% c("county_population", "school_age_children") & 
           sex_modifier == "total") %>% 
  pivot_wider(names_from = indicator, 
              values_from = value) %>% 
  mutate(pc = school_age_children / county_population * 100) %>% 
  ggplot(aes(x = school_age_children, y = fct_rev(fct_relevel(county, population_sort_order)), fill = pc)) + 
  geom_col() + 
  geom_text(aes(label = comma(school_age_children)), 
            colour = "grey20", 
            size = 4, 
            hjust = "inward") +
  scale_fill_viridis(begin = .3, direction = -1) + 
  scale_x_continuous(labels = comma) + 
  labs(x = "School-aged children", 
       y = "", 
       fill = "% of county\npopulation", 
       title = "Number of school-aged children") + 
  theme(legend.title = element_text(size = 8))
  
```

<br> 

The largest numbers of school-aged children are in `r pop_summary %>% filter(school_age_children == max(school_age_children)) %>% pull(county)` County, though `r pop_summary %>% filter(pc == max(pc)) %>% pull(pc) %>% round(digits = 2)`% of all persons in `r pop_summary %>% filter(pc == max(pc)) %>% pull(county)` are of schooling age, the highest of any county. 

<br>

# Enrolment

The plot below shows the net enrolment rates of both sexes at each education level. Counties have been sorted by enrolment at the secondary level. 

```{r fig.height = 9}

enrolment_sort_order <- counties %>% 
  filter(indicator %in% c("Net Enrolment Rate (NER)") & sex_modifier == "total" & 
           age_modifier == "secondary") %>% 
  group_by(county, age_modifier) %>% 
  mutate(sort_value = sum(value)) %>% 
  arrange((sort_value)) %>% 
  pull(county)

counties %>% 
  filter(indicator %in% c("Net Enrolment Rate (NER)") & sex_modifier != "total") %>%
  mutate(age_modifier = recode(age_modifier, 
                               "preprimary_ece" = "Pre-primary/ECE", 
                               "primary" = "Primary", 
                               "secondary" = "Secondary")) %>% 
  ggplot(aes(x = value, 
             y = fct_relevel(county, 
                             enrolment_sort_order), 
             fill = sex_modifier)) + 
  geom_col(position = position_dodge()) + 
  geom_text(aes(label = value), 
            colour = "white", 
            hjust = 1, 
            position = position_dodge(width = .9)) + 
  facet_wrap(~ age_modifier) + 
  labs(x = "Net Enrolment Rate", 
       y = "", 
       title = "Net Enrolment Rate", 
       subtitle = "2020 Basic Education Statistical Book, (K MoE).",
       fill = "") + 
  scale_fill_manual(values = c("#440154", "#1fa187"), 
                    guide = guide_legend(reverse = TRUE)) + 
  theme(strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121"), 
        legend.position = "top")
  
```

<br>

The phenomenon is perhaps a bit more visible below. Turkana had the largest difference between preprimary and secondary enrolment (i.e. the highest amount of attrition). However, it is important to note that male attrition is higher than female attrition across all ASAL counties except Isiolo, with the difference between the sexes being much more pronounced in Marsabit and Mandera. 

<br>

```{r fig.height=7}
diff_sort_order <- counties %>% 
  filter(indicator %in% c("Net Enrolment Rate (NER)") & sex_modifier != "total") %>%
  mutate(age_modifier = recode(age_modifier, 
                               "preprimary_ece" = "Pre-primary/ECE", 
                               "primary" = "Primary", 
                               "secondary" = "Secondary")) %>% 
  pivot_wider(names_from = age_modifier, 
              values_from = value) %>% 
  clean_names() %>% 
  group_by(county) %>% 
  summarise_at(vars(pre_primary_ece, primary, secondary), ~ mean(., na.rm = TRUE)) %>% 
  mutate(diff = pre_primary_ece - secondary) %>%
  arrange((diff)) %>% 
  pull(county)

counties %>% 
  filter(indicator %in% c("Net Enrolment Rate (NER)") & sex_modifier != "total") %>%
  mutate(age_modifier = recode(age_modifier, 
                               "preprimary_ece" = "Pre-primary/ECE", 
                               "primary" = "Primary", 
                               "secondary" = "Secondary")) %>% 
  pivot_wider(names_from = age_modifier, 
              values_from = value) %>% 
  clean_names() %>% 
  # group_by(county) %>% 
  # summarise_at(vars(pre_primary_ece, primary, secondary), ~ mean(., na.rm = TRUE)) %>% 
  mutate(diff = pre_primary_ece - secondary) %>%
  arrange(desc(diff)) %>% 
  ggplot(aes(x = diff, y = fct_relevel(county, diff_sort_order), fill = sex_modifier)) +
  geom_col(position = position_dodge(), 
           width = .8) + 
  geom_text(aes(label = diff), 
            colour = "white", 
            hjust = 1, 
            position = position_dodge(width = .9)) + 
  labs(x = "Difference in preprimary and secondary enrolment rates", 
       y = "", 
       title = "Difference in enrolment rates", 
       subtitle = "2020 Basic Education Statistical Book, (K MoE).",
       fill = "") + 
  scale_fill_manual(values = c("#440154", "#1fa187"), 
                    guide = guide_legend(reverse = TRUE)) + 
  theme(strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121"), 
        legend.position = "top")
  
```


<br>

Let us explore which other factors impact enrolment rate 

```{r}
counties %>% count(indicator)
```


```{r}
line_data <- counties %>% 
  filter(indicator == "Net Enrolment Rate (NER)" | 
           indicator == "Learner-Classroom Ratio in Public Schools") %>% 
  filter(sex_modifier == "total") %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  rename("net_enrolment_rate" = "Net Enrolment Rate (NER)", 
         "learner_classroom_ratio" = "Learner-Classroom Ratio in Public Schools") %>% 
  filter(county != "National") %>%
  mutate(learner_classroom_lag = lag(learner_classroom_ratio), 
         learner_classroom_lag = ifelse(age_modifier == "preprimary_ece", 
                                        NA_integer_, 
                                        learner_classroom_lag), 
         )  %>% 
  filter(county != "Turkana" | age_modifier != "preprimary_ece") %>% 
  filter(!is.na(learner_classroom_lag)) %>% 
  mutate(age_modifier = str_to_title(age_modifier)) 
 
```


```{r fig.retina=2, fig.width=9}
counties %>% 
  filter(indicator == "Net Enrolment Rate (NER)" | 
           indicator == "Learner-Classroom Ratio in Public Schools") %>% 
  filter(sex_modifier == "total") %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  rename("net_enrolment_rate" = "Net Enrolment Rate (NER)", 
         "learner_classroom_ratio" = "Learner-Classroom Ratio in Public Schools") %>% 
  filter(county != "National") %>%
  mutate(learner_classroom_lag = lag(learner_classroom_ratio), 
         learner_classroom_lag = ifelse(age_modifier == "preprimary_ece", 
                                        NA_integer_, 
                                        learner_classroom_lag), 
         ) %>% 
  filter(age_modifier != "preprimary_ece")  %>%
  mutate(age_modifier = str_to_title(age_modifier)) %>% 
  ggplot(aes(x = learner_classroom_lag, 
             y = net_enrolment_rate)) + 
  geom_smooth(method = "lm", 
              fill = "lightblue", 
              data = line_data) +
  geom_point() + 
  geom_text_repel(aes(label = county), 
                  size = 2)  + 
  facet_wrap(~age_modifier, scales = "free") + 
  labs(x = "Learner-classroom ratio of previous education level", 
       y = "Net enrolment rate", 
       title = "Higher learner-classroom ratios correlated with lower net enrolment at next level", 
       subtitle = "Data from 2020 Basic Education Statistical Book, (K MoE)", 
       caption = "Turkana preprimary enrolment excluded because it is an outlier.") + 
  theme(plot.caption = element_text(hjust = .5, size = ), 
        strip.background = element_rect(fill = "black"))


```

<br>

```{r}
learner_classroom_table <- counties %>% 
  filter(indicator == "Net Enrolment Rate (NER)" | 
           indicator == "Learner-Classroom Ratio in Public Schools") %>% 
  filter(sex_modifier == "total") %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  rename("net_enrolment_rate" = "Net Enrolment Rate (NER)", 
         "learner_classroom_ratio" = "Learner-Classroom Ratio in Public Schools") %>% 
  filter(county %out% c("National")) %>%
  filter(county != "Turkana" | age_modifier != "preprimary_ece") %>% 
  mutate(learner_classroom_lag = lag(learner_classroom_ratio), 
         learner_classroom_lag = ifelse(age_modifier == "preprimary_ece", 
                                        NA_integer_, 
                                        learner_classroom_lag), 
         ) %>%
  filter(!is.na(learner_classroom_lag)) %>% 
  group_by(age_modifier) %>% 
  do(tidy(lm(data = ., formula = net_enrolment_rate ~ learner_classroom_lag))) %>% 
  filter(term != "(Intercept)")

```


With reference to the estimate column below and given the limited data available (the digitisation of more counties and more years of data would allow for more robust testing of this hypothesis), an increase of class size  at the preprimary level by 1 learner, it is estimated that the net enrolment rate would be `r learner_classroom_table %>% filter(age_modifier == "primary") %>% pull(estimate) %>% round(digits = 2)` lower at the primary level; an increase of class sizes by 1 learner at the primary level results in a net enrolment rate that is `r learner_classroom_table %>% filter(age_modifier == "secondary") %>% pull(estimate) %>% round(digits = 2)` lower. 

These results are statistically significant. But the data it is drawn from is limited and it might not be an accurate accounting of the phenomenon -- more data is needed, now that we have established that a correlation exists. 

<br> 

```{r}
learner_classroom_table %>% 
  flextable() %>% 
  theme_zebra()
```



